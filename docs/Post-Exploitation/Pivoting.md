# Pivoting

Pivoting is a technique that allows us to use a compromised machine as a tunnel/proxy or simply to
access resources on other machines that we couldn't reach directly, for example in an internal
network.

## Basics

On a compromised machine we can use commands such as `ipconfig` or `ifconfig` or `ip a s` to show
the network interfaces and `route print` or `ip route` to show the network routes. 
This should already give us some information regarding other internal networks.
In addition, we can check the ARP table on the machine with `arp`, that can shows us known hosts.
Finally, using `netstat` or `ss -patunl` we can check established connections that can reveal
additional hosts.

## Arp Scanner

From a Meterpreter session we can run `arp_scanner` that will discover other hosts in the internal
network of choice.

## Ping Sweep

Similarly to the above, by running `post/multi/gather/ping_sweep` we can discover by using ICMP
alive hosts in the internal network (if these answer to ping).

## Netenum

Meterpreter has a built in script `netenum` that can perform a set of tasks concerning network
enumeration (ping sweep, DNS lookups/reverse lookups etc.).

## Routing traffic through the compromised machine

In order to route all the traffic through the meterpreter session we can do the following:

```
route add [INTERNAL_NETWORK] [MASK] [SESSION #]
# verify
route print
# remove
route flush
```

or, from inside the Meterpreter session

```
run autoroute -s [NETWORK]/[MASK]
```

## Portscanning internal networks

If the above routing is configured, we can use `auxiliary/scanner/portscan/tcp` to perform a TCP
port scan on an internal network.

## Generic Approach to routing

If we have an established session through Metasploit, we can use external tool through it by using
socks4 proxy + proxychain.

First, we can configure the socks4 proxy in Metasploit.

```
use auxiliary/servers/socks4a
```

then we can modify `/etc/proxychains.conf` and add

```
socks4 127.0.0.1 [SRVPORT]
```

Now we can run any tool we want using proxychains, and this will be router through our metasploit
session, that in turn can also route through a session if the `route add` command was used.

```
# Nmap -> proxychains -> socks4 -> meterpreter session N -> compromised machine -> internal network
proxychains nmap -sT -Pn -n [INTERNAL_NETWORK]
```

Not that when running through proxychains, we need to use a connect scan in Nmap, as a SYN scan
won't work.

### Portfwd

A similar approach, but for a single port, can be taken using the metasploit `portfwd` script.

```
# This will forward local LOCAL_PORT to REMOTE_HOST:REMOTE_PORT
portfwd add -l [LOCAL_PORT] -p [REMOTE_PORT] -r [REMOTE_HOST]
```



