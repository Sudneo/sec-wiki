## Windows Authentication Weaknesses

Exploiting weak Windows authentication (protocols) it is possible to gain access to systems or to
elevate own privileges. This is another possible low-hanging fruit that should always be tested
before passing to more advanced technique.

### Authentication Protocols

Nowadays Kerberos is the default authentication protocol within Windows domains. Despite this,
networks and machines are still largely compatible with NTLM (NT LAN Manager), which is used for
example when authentication is performed against a server that doesn't belong to the same domain.

#### NTLM Flow

The NTLM flow consists of three steps:

* Client sends a request to the server (containing Username in plaintext)
* Servers generates a challenge and sends it to the client
* The client encrypts the challenge with the hash of the user's password and sends the result to the
  server

#### Password Hashes

The 3rd step in the previous description is clearly the crucial one and depends on how it is
implemented.

#### LM Hash

The first implementeation was LM (which later got superseded by NTLM, then by NTLMv2 and
finally by Kerberos). 

LM hashes are extrememly weak. The algorithm uses DES after the following steps:

* Make password upper case
* Pad with null bytes to 14 bytes
* Split the password in 2 blocks of 7+1 parity byte
* Encrypt each piece with a fixed key
* Concatenate the two encrypted strings

#### NTLMv1 Hash

The NTLMv1 hash brings some improvements, such as using Unicode for password encoding and using MD4
to generate the hash

#### Attack on LM and NTLMv1

Whether LM or NTLMv1 hashes are used, the attacks are similar. Either a client is forced to connect
to the attacker (therefore submitting his hash) or the attacker performs MiTM between the client and
a legit server.

There are [rainbow tables](http://project-rainbowcrack.com/table.htm) built for hashes generated with a fixed challenged ('1122334455667788'), so
this can be used to crack the hashes obtained. It is also possibl to use an offline Password
Cracking tool to perform this task.

#### Cracking a LM Hash

Cracking tools often will give us just the first half of the password given the hash, in order to
recover the second part, tools such as `halflm_second.rb` (part of Metasploit) can be used:

```bash
ruby halflm_second.rb -n [HASH] -p [FIRST_HALF_CRACKED]
```

At this point the password obtained is likely to be all uppercase, and we can use tools such as
`netntlm.pl` to recover the original password:

```bash
# netntlm can recover also the second half, skipping the previous step
perl netntlm.pl --seed [CRACKED_PASS] --file [FILE_WITH_HASH]
```

#### NTLMv2 

The NTLMv2 protocol improved the security, introducing HMAC-MD5, making challenge-responses unique
by using a timestamp. Attacks that worked for previous versions of the protocol don't work for
NTLMv2.

In order to attack NTLMv2 we can use SMB Relay attack.

#### SMB Relay

The idea of the attack is to wait until a client wants to authenticate to the attacker's machine,
then relaying this request to the target. The target will send a challenge that gets sent back to
the client, and finally the response from the client gets sent to the target machine.

[Responder](https://github.com/lgandx/Responder) implements several attacks against Windows
authentication, including Multirelay which performs this attack against multiple targets at once.




